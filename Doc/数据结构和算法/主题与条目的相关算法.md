# 主题与条目的相关算法


## 实现功能
### 编辑
* 添加主题
* 添加主题路径
* 删除主题路径（不能直接删除主题，只有在删除一个主题的最后一条路径时才会自动删除主题）
* 修改主题
    * 修改主题名称
    * 修改主题内部信息
    * 修改主题ID在树中的位置
* 添加条目
* 删除条目
* 修改条目
    * 修改条目内部信息
    * 修改条目的大类和子类

### 搜索
* 主题搜索
* 条目搜索
* 搜索结果排序

### 推荐
* 相关主题



## 算法逻辑
### 主题路径根据主题ID树的变化动态更新
1. 主题ID树如果发生变化，除了在枝末端添加新主题的情况下，都需要更改已有的主题路径
2. 因此需要对【主题ID——主题路径】映射数组、【【应该不需要了】条目ID——主题路径】对象和
【主题路径——条目ID】对象进行更新
3. 【主题ID——主题路径】映射数组可以直接遍历主题ID树整体重新生成新的数据结构，但另外两个
数据结构并不能整体重新生成。
4. 难道需要遍历每个主题路径，找到相关的路径并逐个更新。能不能让主题路径数组成为动态的，
而不是像现在这样是固定的几个数字组成的数组。


### 编辑
#### 添加主题
1. 确定新添加的主题名不存在于现有主题系统中
2. 根据主题信息组建主题对象，push到【主题ID——主题对象】映射数组
3. 将新添加的主题名push到【主题ID——主题名】映射数组

#### 添加主题路径
1. 在【主题ID树】对象中加入该主题ID（见下面的“修改主题ID树”）
2. 根据对主题ID树的修改情况，确定要如何修改主题路径。（见下面的“修改主题ID树”）
3. 在【主题ID——主题路径】映射数组，添加新的路径。如果有则修改其他需要包含该ID的主题路径
。
4. 在【主题路径——条目ID】对象中，添加新的主题路径作为键，值为空数组。如果有则修改其他需
要包含该ID的主题路径。
5. 【应该不需要了】如果需要则修改相关主题路径，在【条目ID——主题路径】对象中找到并做出相
应修改。
6. 在【主题路径——条目ID】对象中，根据要修改的路径找到对应的条目ID。在【条目系统】数组找
到对应的条目，修改其中对应的路径。

#### 删除主题路径
1. 从【主题ID树】对象中移除该ID节点（见下面的“修改主题ID树”）
2. 根据对主题ID树的修改情况，确定要如何修改主题路径。（见下面的“修改主题ID树”）
3. 从【主题ID——主题路径】映射数组移除该主题ID对应的项。如果有则修改其他包含该ID的主题路
径。
4. 如果【主题ID——主题路径】映射数组该主题ID对应的数组已经为空数组，则移除该项。同时，从
【主题ID——主题名】映射数组和【主题ID——主题对象】移除该主题映射。该主题被彻底移除。
5. 从【主题路径——条目ID】对象中移除该主题ID的路径对应的键值对。如果有则修改其他包含该ID
的主题路径。
6. 【应该不需要了】从【条目ID——主题路径】对象中移除该主题ID的路径对应的键值对。如果有则
修改其他包含该ID的主题路径。
7. 根据第5步获取到的条目ID，在【条目系统】数组找到对应的条目，删除其中对应的路径。

#### 修改主题
##### 修改主题名称
修改【主题ID——主题名】映射数组
##### 修改主题内部信息
修改【主题ID——主题对象】映射数组
##### 修改主题ID在树中的位置
见下面的“修改主题ID树”

#### 添加条目
1. 确定新添加的条目不存在于现有条目系统中
2. 添加进【条目系统】数组
3. 【应该不需要了】为该条目至少添加一个主题路径，在【条目ID——主题路径】对象中添加映射
4. 在【主题路径——条目ID】对象添加映射

#### 删除条目
1. 从【条目系统】数组中移除
2. 【应该不需要了】从【条目ID——主题路径】对象中移除映射
3. 在【主题路径——条目ID】对象添加映射移除条目

#### 修改条目
##### 修改条目自身信息
在【条目系统】数组中，找到该条目对象，修改其`info`属性
##### 修改条目主题信息
即，修改条目对象的`subjects`属性
###### 添加主题（路径）
1. 在【条目系统】数组中的条目对象添加主题路径
2. 在【主题路径——条目ID】对象中对应的路径里添加条目ID
###### 删除主题（路径）
1. 在【条目系统】数组中的条目对象删除主题路径
2. 在【主题路径——条目ID】对象中对应的路径里删除条目ID
##### 修改条目的大类和子类
1. 在【条目系统】数组中移动条目分组，同时记录异动前和移动后的ID
2. 【应该不需要了】在【条目ID——主题路径】对象中修改原条目ID
3. 【主题路径——条目ID】对象中修改原条目ID

### 避免条目重复添加
目前的情况不能完全避免重复

条目类型 | 唯一识别
--|--
书籍 | sISBN
期刊 | 标题和期号
音乐 | 专辑名称和音乐人
游戏 | 名称（如果是电子游戏，还有开发者）
戏剧 | 名称和表演者
网络媒体 | 网址或应用名称
绘画或摄影 | 标题和作者
展会或展馆 | 名称

### 搜索
#### 主题搜索
1. 输入一个主题名，在【主题ID——主题名】映射数组中找到对应的主题ID
2. 根据该主题ID，在【主题ID——主题路径】映射数组中找到该主题的若干主题路径数组
3. 在【主题路径——条目ID】映射中找到上述主题路径对应的的条目ID
4. 在【条目系统】数组中找到相应的条目信息

#### 条目搜索
遍历【条目系统】数组并按照大类和子类对结果分类

#### 搜索结果筛选和排序
符合以下条件之一的才会呈现在搜索结果中，并且按照以下顺序排序：
1. 搜索词与主名称完全符合
2. 搜索词与别名或译名完全符合
3. 搜索词与主名称部分符合（完全包含或完全被包含）
    * 如果译名或别名只有一个字且被搜索词包含，则不计入搜索结果
4. 搜索词与别名或译名部分符合（完全包含或完全被包含）
    * 如果译名或别名只有一个字且被搜索词包含，则不计入搜索结果
    * 因为译名可能是空字符串，而任何字符串都可以包含空串，所以要排除空串的情况。
5. 搜索词包含于主题或条目描述中


### 推荐
#### 相关主题推荐
* 三级或更低级别的主题，推荐其父主题
* 三级或更低级别的主题，如果它的同父主题不超过9个，则任选5个作为推荐主题。


### 修改主题ID树
#### 添加
添加时必须要添加为某个节点的子节点。分为两种情况：添加中间子节点和添加末端子节点。
##### 添加中间子节点
1. 如果一个节点已有子节点，为其添加新的子节点时，新的子节点会插在现有的父子结构中间，即
新的节点成为原子节点的父节点，从而形成三级结构，则为添加中间子节点。
2. 添加中间子节点之后，新加节点的所有多级子节点的路径都发生了变化，即在路径中又多了一个
节点。除了新加一条新节点的主题路径以外，还要修改若干已有的主题路径。
##### 添加为末端子节点
1. 如果一个节点已有子节点，为其添加新的子节点时，新的子节点和已有的子节点如果是同级的，
新添加的节点不存在子节点，则为添加末端子节点。或者一个节点没有子节点，则首次为其添加子节
点时，也是添加末端子节点。
2. 添加末端子节点时，只是新加了一条主题路径，现有的主题路径不需要发生改变。

#### 删除
##### 删除中间节点
删除中间子节点之后，节点所在的所有路径都发生了变化，即在路径中少了一个节点。除了删除该主
题ID本身的若干路径以外，还要修改若干已有的主题路径。
##### 删除为末端节点
删除末端子节点时，只是删除了该主题ID本身的若干路径，其他主题路径不需要发生改变。

#### 移动位置
1. 使用上面“删除主题路径”的方法删除当前路径，但要跳过第4步，避免彻底删除主题。
2. 使用上面“添加主题路径”的方法，新建一条主题路径。
